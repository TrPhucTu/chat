<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeChat - Tin nhắn tự hủy</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --sender-bg: #0084ff;
            --receiver-bg: #e4e6eb;
            --text-main: #050505;
            --text-sub: #65676b;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-color); height: 100vh; display: flex; justify-content: center; }
        
        /* Màn hình đăng nhập */
        #login-overlay { position: fixed; inset: 0; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .login-box { text-align: center; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        input[type="password"] { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        
        /* Khung Chat */
        #app-container { width: 100%; max-width: 500px; background: white; display: none; flex-direction: column; height: 100vh; position: relative; }
        header { padding: 15px; border-bottom: 1px solid #ddd; text-align: center; font-weight: bold; background: white; }
        
        #messages-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        
        /* Bong bóng chat */
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 18px; font-size: 15px; position: relative; word-wrap: break-word; }
        .msg.me { align-self: flex-end; background: var(--sender-bg); color: white; border-bottom-right-radius: 4px; }
        .msg.them { align-self: flex-start; background: var(--receiver-bg); color: var(--text-main); border-bottom-left-radius: 4px; }
        
        .seen-status { font-size: 11px; color: var(--text-sub); margin-top: 2px; align-self: flex-end; }
        
        /* Ô nhập liệu */
        #input-form { padding: 15px; display: flex; gap: 10px; border-top: 1px solid #eee; background: white; }
        input[type="text"] { flex: 1; padding: 12px 18px; border: none; background: #f0f2f5; border-radius: 20px; outline: none; }
        button { background: var(--sender-bg); color: white; border: none; padding: 0 20px; border-radius: 20px; cursor: pointer; font-weight: 600; }
        button:hover { opacity: 0.9; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2>Mật khẩu phòng</h2>
            <input type="password" id="pass-input" placeholder="Nhập mật khẩu để tiếp tục...">
            <button onclick="checkPassword()" style="width: 100%; padding: 12px;">Bắt đầu Chat</button>
        </div>
    </div>

    <div id="app-container">
        <header>Phòng Chat Riêng Tư</header>
        <div id="messages-container"></div>
        <form id="input-form">
            <input type="text" id="msg-input" placeholder="Nhập tin nhắn..." autocomplete="off">
            <button type="submit">Gửi</button>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CẤU HÌNH FIREBASE ---
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAJ6-NROXGUvGcNTI4xN6xl5NI7xJYfNVo",
  authDomain: "secret-chat-7b6b1.firebaseapp.com",
  projectId: "secret-chat-7b6b1",
  storageBucket: "secret-chat-7b6b1.firebasestorage.app",
  messagingSenderId: "5158361802",
  appId: "1:5158361802:web:2255cc13fdab7fc8f0b233",
  measurementId: "G-SL7T6GT3TK"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const PASS_KEY = "123456"; // Đổi mật khẩu tại đây

        // Xử lý login phía client
        window.checkPassword = () => {
            const input = document.getElementById('pass-input').value;
            if(input === PASS_KEY) {
                signInAnonymously(auth).catch(err => alert("Lỗi kết nối Firebase: " + err.message));
            } else {
                alert("Mật khẩu không đúng!");
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                startChat();
            }
        });

        // Gửi tin nhắn
        document.getElementById('input-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('msg-input');
            const val = input.value.trim();
            if(!val) return;

            await addDoc(collection(db, "messages"), {
                text: val,
                senderId: auth.currentUser.uid,
                createdAt: serverTimestamp(),
                seen: false,
                seenAt: null
            });
            input.value = "";
        };

        // Nhận tin nhắn và tự động xóa
        function startChat() {
            const q = query(collection(db, "messages"), orderBy("createdAt", "asc"));
            
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('messages-container');
                container.innerHTML = "";
                
                snapshot.forEach((msgDoc) => {
                    const data = msgDoc.data();
                    const isMe = data.senderId === auth.currentUser.uid;
                    const msgId = msgDoc.id;

                    // 1. Logic: Đánh dấu đã xem
                    if (!isMe && !data.seen) {
                        updateDoc(doc(db, "messages", msgId), {
                            seen: true,
                            seenAt: serverTimestamp()
                        });
                    }

                    // 2. Logic: Tự hủy sau 10 phút kể từ khi xem (600.000 ms)
                    if (data.seen && data.seenAt) {
                        const now = Date.now();
                        const seenTime = data.seenAt.toMillis();
                        const diff = now - seenTime;
                        if (diff > 600000) { 
                            deleteDoc(doc(db, "messages", msgId));
                            return; // Không render tin nhắn đã bị xóa
                        }
                    }

                    renderUI(data, isMe, container);
                });
                container.scrollTop = container.scrollHeight;
            });
        }

        function renderUI(data, isMe, container) {
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'me' : 'them'}`;
            div.textContent = data.text;
            container.appendChild(div);

            if (isMe && data.seen) {
                const seenTag = document.createElement('div');
                seenTag.className = 'seen-status';
                seenTag.textContent = 'Đã xem';
                container.appendChild(seenTag);
            }
        }
    </script>
</body>
</html>